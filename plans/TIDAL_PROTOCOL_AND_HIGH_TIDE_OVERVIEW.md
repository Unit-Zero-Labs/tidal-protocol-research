# Tidal Protocol and "High Tide" Scenario: A Comprehensive Overview

This document provides a complete overview of the Tidal Protocol simulation framework, with a special focus on the "High Tide" scenario. It synthesizes information from various scripts and markdown files to offer a unified understanding of the protocol, its actively managed lending strategy, and the tools for simulation and analysis.

## 1. The Tidal Protocol: Core Concepts

The Tidal Protocol is a simulated lending platform. At its core, it allows users (agents) to:

1.  **Supply collateral**: Initially, the focus is on supplying Bitcoin (BTC).
2.  **Borrow stablecoins**: Agents can borrow the stablecoin MOET against their collateral.

The protocol's health and risk are managed through mechanisms like **collateral factors**, **liquidation thresholds**, and a **kinked interest rate model** for borrowing. The protocol also features liquidity pools for swapping assets, which is crucial for the rebalancing mechanics in the High Tide scenario.

### Key Components from the Code (`tidal_protocol_sim/core/protocol.py`):

-   **`Asset`**: An enum representing the different cryptocurrencies supported (BTC, ETH, MOET, etc.).
-   **`AssetPool`**: Manages the supply and borrowing of a single asset, including its interest rate model.
-   **`LiquidityPool`**: Represents a MOET trading pair (e.g., MOET/BTC) and is used for swaps.
-   **`TidalProtocol`**: The main class that orchestrates the lending and borrowing mechanics.

## 2. The "High Tide" Scenario: Active Position Management

"High Tide" is not just a simple simulation; it's a sophisticated, actively managed lending strategy designed to protect users during market downturns. It contrasts with traditional lending protocols (like Aave) where users are passively liquidated when their collateral value drops.

### Core Mechanics

The High Tide scenario follows this flow:

1.  **Deposit and Borrow**: An agent deposits 1 BTC as collateral and borrows MOET stablecoins up to a certain "health factor."
2.  **Automatic Yield Generation**: The borrowed MOET is immediately and automatically used to buy **yield-bearing tokens**. These tokens continuously accrue interest (e.g., at a 10% APR).
3.  **Health Factor Monitoring**: The protocol constantly monitors each agent's **health factor** (a measure of the safety of their loan).
4.  **Active Rebalancing**: If an agent's health factor drops below a predetermined "maintenance" threshold due to a fall in BTC price, the system automatically sells just enough of the agent's yield-bearing tokens to repay a portion of their debt and restore their health factor to a safer level.
5.  **Liquidation as a Last Resort**: If the BTC price drops so fast and so far that selling all of an agent's yield tokens isn't enough to save the position, a traditional liquidation occurs.

The central idea is to use the value generated by the yield tokens to proactively manage debt and avoid the costly liquidations common in other protocols.

## 3. The Simulation Framework

A comprehensive simulation framework has been developed to test, validate, and visualize the effectiveness of the High Tide strategy, especially when compared to a traditional Aave-like model.

### Key Components

-   **`HighTideSimulationEngine` (`tidal_protocol_sim/simulation/high_tide_engine.py`)**: This is the heart of the simulation. It's a specialized engine that orchestrates the High Tide scenario, managing the agents, the price changes, and the protocol state.

-   **`HighTideAgent` (`tidal_protocol_sim/agents/high_tide_agent.py`)**: This agent is the implementation of the High Tide user. It contains the logic for monitoring its health factor and deciding when to execute a rebalancing action. Agents are categorized into **risk profiles** (Conservative, Moderate, Aggressive) based on their initial health factor, which determines how much risk they take on.

-   **`BTCPriceDeclineManager`**: This component simulates a stressful market conditionâ€”a gradual but significant decline in the price of BTC, based on historical volatility patterns. This is the trigger for the rebalancing events.

-   **`YieldTokenManager` and `YieldTokenPool`**: These manage the minting, burning, and trading of the yield-bearing tokens that are central to the High Tide strategy.

### Running Simulations and Comparisons

Several scripts are provided to run simulations and analyses:

-   **`run_high_tide_demo.py`**: A quick demonstration script that runs a single High Tide scenario with a predefined number of agents and shows the results.

-   **`run_high_tide_vs_aave_comparison.py`**: runs a Monte Carlo analysis (many simulation runs with slight variations) to statistically compare the performance of the High Tide strategy against a traditional Aave-style liquidation model under the same market conditions.

-   **`comprehensive_realistic_pool_analysis.py`**: runs the High Tide simulation across various liquidity pool configurations (different sizes) to analyze how pool depth affects rebalancing costs, slippage, and overall agent outcomes.

## 4. Analysis and Visualization

### Key Metrics Tracked

-   **Survival Rate**: The percentage of agents who avoid liquidation.
-   **Cost of Rebalancing/Liquidation**: The total value lost by agents due to rebalancing events (including trading fees and slippage) or liquidations.
-   **Net Position Value**: The final value of an agent's holdings (collateral + yield tokens - debt).
-   **Rebalancing Events**: The number and size of rebalancing trades.
-   **Protocol Utilization**: How much of the available liquidity is being used.

### Visualization Suite

The `tidal_protocol_sim/analysis/high_tide_charts.py` module and other analysis scripts can generate a wide array of charts, including:

-   **Net Position Value Over Time**: Tracks the value of agent positions as the price of BTC declines.
-   **Health Factor Distribution**: Shows how the health factors of the agents change throughout the simulation.
-   **Rebalancing Timeline**: Overlays rebalancing events on the BTC price chart to show when they occurred.
-   **Agent Performance Summaries**: Provides a breakdown of outcomes by risk profile.
-   **LP Curve Evolution**: Shows how the liquidity in the trading pools changes in response to rebalancing trades.
-   **Comprehensive Dashboards**: Combines multiple analyses into a single view for comparing different pool configurations.

These visualizations are critical for understanding the trade-offs in the system and for demonstrating the benefits of the High Tide strategy to stakeholders.

## 5. Summary

The Tidal Protocol simulation project is a sophisticated framework for exploring an innovative, actively managed lending strategy called "High Tide." By simulating a stressful market scenario (a BTC price decline) and comparing the High Tide model to traditional passive liquidation models, the project provides robust, data-driven insights into how active rebalancing can improve user outcomes and protocol stability. The comprehensive analysis and visualization tools make these insights accessible and actionable.
